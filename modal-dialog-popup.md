# dialog popover api考察

dialogのロジック
[/src/assets/modules/dialog.ts]

## htmx
ポップアップされるコンテンツをhtmxの`data-hx-get`,`data-hx-swap`を使用し挿入する場合、ページ内に設置されている`<dialog>`,`[popover]`要素にすでに設置されているクローズボタンなどのフォーカス順がコントロールしにくい(EX:クローズボタンを最後にフォーカスさせたいなど)


## popover api
現時点でfirefoxがpopover apiに対応していないため、フォローバック工数が多い。特にpolyfillを導入しても`::backdrop`がないためモーダルUIとして使うのは難しい。
対応策として、直前の要素に`span`を設置し

```css
	  span:has( + .\:popover-open) {
			content: '';
			position: fixed;
			inset: 0;
			background-color: var(--modal-backdrop-background-color);
			z-index: 1;
	  }
```

とするなどが必要。。だが、原則popoverにバックドロップはいらない、

良い点として、ボタンとポップアップの紐づけがhtml上で完結するため動的なコンテンツ取得などを考えなければ実装可能と思われる。
ベストプラクティスに沿ってトリガーとポップアップは隣接してマークアップすることが望ましい。
ブラウザによってpopover内からフォーカスがハズレた場合の挙動がまちまちなため

その上で、以下の場合は特にpopover apiの実装を避けるべきという結論に至った
- focus trapの実装が適切（modalとして実装する必要がある）
- 複数のモーダルを使用しユーザーの行動をヘルプする必要がある

翻って以下の場合はpopoverを積極的に利用して良い
- 発火元のボタンと近い場所に実装すべき開閉UI
- 閉じる必要が特になくフォーカスがpopover外に流れても良い

### スタイリング
ページ内の様々な場所で様々な用途で使用されるため共通のスタイルは控え、個別にスタイリングを行ったほうが無難

```css
.sub-menu {..}
]
.sub-menu:popover-open {...}
```

## dialogとモーダル
dialogはモーダルであったほうが実装の管理もUIの統一からも良いと思われる
例えばコンテンツ内の用語の詳細をポップアップで表示させる場合に
「開く→理解→閉じる」
は一定の対話であるとみなすことでdialog要素を使うことが可能となる
また、複数のポップアップを使用してユーザーの行動を促していく場合（ex:申し込み前の分岐など)などもフォーカスを一定にする必要があることからdialog用ををモーダルとして使用することが望ましい

### フォーカストラップについて

フォーカストラップは
- ESCキーによる離脱
- モーダルコンテキスト内にクローズボタン
- モーダルの外領域のクリックによるモードレスへの移行
を実装することで問題なく使用できる。
上記を用意できない場合は`<dialog>`の`showModal()`で制御できる実装に留める。（モーダル内の最後のフォーカス要素の次はブラウザUIへフォーカスする）

### `dialogEl.show()`と`dialogEl.showModal()`の使い分け

#### show()
cookieバナーなどユーザーに認識してほしいが行動を制限する必要のないものいわゆるトーストUIなどには`show()`またはpopover apiの`popover="manual"`を使用し、ユーザーが積極的に閉じない限り表示したままにできるようにする。明確なラベルを持ったボタン要素を挿入できる場合は閉じるボタンは不要

#### showModal()
ユーザーがフォーカスしてタスクを実行することが有益な場合は`showModal()`を使用する。
例えば、購入の完了までのフローなど。（ただし本来は別ページとして誘導することが好ましい）その場合はユーザーによる離脱が可能なUIを同時に提供する。


## :targetを使用してモーダルっぽく実装する

モーダル表示（ポップアップ表示）はあくまでスクリーンビューワー用のデザインであるためjsを用いた小難しい実装をしないでcssのみで簡易に実装すべきという思想。
思想自体には賛成するが以下の問題点がある。

- モーダルを開く度にブラウザヒストリーが増えていくが、ユーザーにとっては同一ページ内のインタラクションでありブラウザバック時に期待している挙動と一致しない。
  - とはいえページ内アンカーでの移動と同じ友言えるためそこまで気にする必要はないかも知れない。
- モーダル要素のマークアップ位置がモーダル閉鎖時のフォーカスに影響を与える可能性がある。dialog要素はこれが問題ないことがポイントが高い。

フォローバックの工数を考えると積極的に使用する必要はなさそう。


## 実装と保守

WEBサイト視点で考えると、どのページにも共通して挿入したいモーダルをどの様に管理するかを考慮したい。
モーダルであると割り切って必要なエージのbodyのbefore endに挿入してしまうのが管理しやすい。htmxを使用する場合はbutton要素自体に
```html
<button
				type="button"
				data-js-dialog="dialog-id"
				data-hx-trigger="load"
				data-hx-get="/include/inc"
				data-hx-target="body"
				data-hx-swap="beforeend"
			>
				open dialog
			</button>
```
とできると可搬性が高い。ただし複数のトリガーを設置する場合は注意する。
layoutとして使用するページ内一意なコンポーネントに入れ込めると良い

→HTMXを使用し挿入されるものは同じなのでdialogとbuttonの紐づけをid属性にしなければクライアント側で問題ない。
